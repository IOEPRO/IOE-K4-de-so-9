
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LUY·ªÜN THI IOE L·ªöP 4 - ƒê·ªÄ S·ªê 09</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
      :root {
        --primary: #4f46e5;
        --secondary: #10b981;
        --danger: #ef4444;
        --warning: #f59e0b;
      }
      body { 
        font-family: 'Plus Jakarta Sans', sans-serif; 
        background-color: #f8fafc; 
        margin: 0;
        overflow-x: hidden;
      }
      .font-nunito { font-family: 'Nunito', sans-serif; }
      .custom-scrollbar::-webkit-scrollbar { width: 6px; }
      .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
      .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
      @keyframes float {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-10px); }
      }
      .animate-float { animation: float 3s ease-in-out infinite; }
      .glass {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.3);
      }
      .btn-pop { transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
      .btn-pop:active { transform: scale(0.94); }
      .question-card-enter { animation: slideIn 0.5s cubic-bezier(0.23, 1, 0.32, 1) forwards; }
      @keyframes slideIn {
        from { opacity: 0; transform: translateY(30px) scale(0.95); }
        to { opacity: 1; transform: translateY(0) scale(1); }
      }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
</head>
<body class="antialiased">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useRef, useMemo } = React;

      const TOTAL_TIME = 35 * 60; 
      const POINTS_PER_CORRECT = 10;

      const QuestionType = {
        MULTIPLE_CHOICE: 'MC',
        FILL_IN_BLANK: 'FIB',
        REARRANGE: 'RE'
      };

      const GameState = { START: 'START', PLAYING: 'PLAYING', FINISHED: 'FINISHED' };

      const RAW_QUESTIONS = [
        { id: 1, type: QuestionType.FILL_IN_BLANK, text: "___ John at home yesterday?", answer: "Was", exp: "D√πng 'Was' cho c√¢u h·ªèi qu√° kh·ª© ƒë∆°n v·ªõi ch·ªß ng·ªØ s·ªë √≠t.", hint: "C√¢u h·ªèi th√¨ qu√° kh·ª© c·ªßa ƒë·ªông t·ª´ To Be v·ªõi 'John' (s·ªë √≠t)." },
        { id: 2, type: QuestionType.REARRANGE, parts: ["What", "do", "you", "like", "doing?"], answer: "What do you like doing?", exp: "C·∫•u tr√∫c h·ªèi s·ªü th√≠ch: What + do/does + S + like + V-ing?", hint: "B·∫Øt ƒë·∫ßu b·∫±ng t·ª´ ƒë·ªÉ h·ªèi 'What' v√† k·∫øt th√∫c b·∫±ng 'doing?'." },
        { id: 3, type: QuestionType.REARRANGE, parts: ["Can", "she", "read", "a", "book?"], answer: "Can she read a book?", exp: "C·∫•u tr√∫c h·ªèi kh·∫£ nƒÉng: Can + S + V?", hint: "C√¢u h·ªèi b·∫Øt ƒë·∫ßu v·ªõi 'Can'." },
        { id: 4, type: QuestionType.FILL_IN_BLANK, text: "She has three ______ on her desk.", img: "https://images.unsplash.com/photo-1550985543-49bee3167284?w=400", answer: "rulers", exp: "S·ªë nhi·ªÅu c·ªßa ruler l√† rulers.", hint: "T·ª´ n√†y c√≥ 6 ch·ªØ c√°i, b·∫Øt ƒë·∫ßu b·∫±ng 'r', nghƒ©a l√† c√¢y th∆∞·ªõc." },
        { id: 5, type: QuestionType.MULTIPLE_CHOICE, text: "Can Nam play table tennis? ‚Äì Yes, he ___.", options: ["can", "can‚Äôt", "canot", "cannot"], answer: "can", exp: "Tr·∫£ l·ªùi kh·∫≥ng ƒë·ªãnh cho c√¢u h·ªèi Can l√† 'Yes, S + can'.", hint: "C√¢u tr·∫£ l·ªùi 'Yes' lu√¥n ƒëi k√®m v·ªõi d·∫°ng kh·∫≥ng ƒë·ªãnh." },
        { id: 6, type: QuestionType.MULTIPLE_CHOICE, text: "She is ... Japan.", options: ["down", "up", "from", "under"], answer: "from", exp: "Be from: ƒë·∫øn t·ª´ ƒë√¢u ƒë√≥.", hint: "Gi·ªõi t·ª´ ch·ªâ xu·∫•t x·ª©, qu√™ qu√°n." },
        { id: 7, type: QuestionType.MULTIPLE_CHOICE, text: "What subjects do you ___ ? ‚Äì I don‚Äôt like Maths and Art.", options: ["dislike", "like", "don‚Äôt like", "love"], answer: "like", exp: "H·ªèi s·ªü th√≠ch m√¥n h·ªçc: What subjects do you like?", hint: "C√¢u tr·∫£ l·ªùi l√† 'don't like' n√™n c√¢u h·ªèi th∆∞·ªùng l√† 'do you like...?'." },
        { id: 8, type: QuestionType.MULTIPLE_CHOICE, text: "Peter can ‚Ä¶ a bike.", options: ["ride", "play", "stay", "drink"], answer: "ride", exp: "Ride a bike: ƒëi xe ƒë·∫°p.", hint: "ƒê·ªông t·ª´ ƒëi k√®m v·ªõi 'bike' ƒë·ªÉ ch·ªâ vi·ªác l√°i xe ƒë·∫°p." },
        { id: 9, type: QuestionType.FILL_IN_BLANK, text: "S_ ORT", answer: "P", exp: "T·ª´ v·ª±ng: Sport (th·ªÉ thao).", hint: "Ch·ªØ c√°i c√≤n thi·∫øu ƒë·ªÉ t·∫°o th√†nh t·ª´ 'Th·ªÉ thao'." },
        { id: 10, type: QuestionType.FILL_IN_BLANK, text: "A: Good n_ _ _ _ , Mom. - B: Have a good sleep, my son.", answer: "night", exp: "Ch√∫c ng·ªß ngon: Good night.", hint: "L·ªùi ch√∫c tr∆∞·ªõc khi ƒëi ng·ªß, c√≥ 5 ch·ªØ c√°i." },
        { id: 11, type: QuestionType.REARRANGE, parts: ["Happy", "birthday", "to", "you,", "Jenny."], answer: "Happy birthday to you, Jenny.", exp: "L·ªùi ch√∫c m·ª´ng sinh nh·∫≠t.", hint: "C√¢u ch√∫c sinh nh·∫≠t quen thu·ªôc." },
        { id: 12, type: QuestionType.FILL_IN_BLANK, text: "FRIE_ D", answer: "N", exp: "T·ª´ v·ª±ng: Friend (b·∫°n b√®).", hint: "Ch·ªØ c√°i c√≤n thi·∫øu trong t·ª´ 'Ng∆∞·ªùi b·∫°n'." },
        { id: 13, type: QuestionType.FILL_IN_BLANK, text: "What is your h_ _ _ y? ‚Äì I like drawing.", answer: "hobby", exp: "Hobby: s·ªü th√≠ch.", hint: "T·ª´ n√†y c√≥ nghƒ©a l√† s·ªü th√≠ch, b·∫Øt ƒë·∫ßu b·∫±ng 'h' v√† k·∫øt th√∫c b·∫±ng 'y'." },
        { id: 14, type: QuestionType.REARRANGE, parts: ["This", "is", "my birthday", "party."], answer: "This is my birthday party.", exp: "Gi·ªõi thi·ªáu b·ªØa ti·ªác sinh nh·∫≠t.", hint: "B·∫Øt ƒë·∫ßu b·∫±ng 'This'." },
        { id: 15, type: QuestionType.REARRANGE, parts: ["I‚Äôm", "very", "well,", "too."], answer: "I‚Äôm very well, too.", exp: "Ph·∫£n h·ªìi s·ª©c kh·ªèe: T·ªõ c≈©ng r·∫•t kh·ªèe.", hint: "B·∫Øt ƒë·∫ßu b·∫±ng ch·ªß ng·ªØ 'I'm'." },
        { id: 16, type: QuestionType.FILL_IN_BLANK, text: "All the water in the oceans and _ _ _ _ is salt water.", audio: "https://res.ioe.vn/edu/EOlympic/ExamData/ImageExam/2018/11/29/636790887695176741_Audio.mp3", answer: "sea", exp: "Sea: bi·ªÉn. N∆∞·ªõc bi·ªÉn m·∫∑n.", hint: "T·ª´ c√≥ 3 ch·ªØ c√°i, nghƒ©a l√† bi·ªÉn." },
        { id: 17, type: QuestionType.FILL_IN_BLANK, text: "Where ___ the dolls?", answer: "are", exp: "The dolls l√† s·ªë nhi·ªÅu n√™n d√πng are.", hint: "ƒê·ªông t·ª´ To Be ƒëi v·ªõi danh t·ª´ s·ªë nhi·ªÅu 'dolls'." },
        { id: 18, type: QuestionType.FILL_IN_BLANK, text: "He is from _________ .", audio: "https://res.ioe.vn/edu/EOlympic/ExamData/ImageExam/2013/11/21/635206402675416532_Audio.mp3", answer: "Singapore", exp: "Nghe ƒë·ªãa danh: Singapore.", hint: "T√™n m·ªôt qu·ªëc gia ·ªü ƒê√¥ng Nam √Å, b·∫Øt ƒë·∫ßu b·∫±ng 'S'." },
        { id: 19, type: QuestionType.FILL_IN_BLANK, text: "Please ____ me some more sugar.", answer: "give", exp: "Give me: ƒë∆∞a cho t√¥i.", hint: "ƒê·ªông t·ª´ c√≥ 4 ch·ªØ c√°i, nghƒ©a l√† 'cho' ho·∫∑c 'ƒë∆∞a'." },
        { id: 20, type: QuestionType.MULTIPLE_CHOICE, text: "Mary and Linda are ... .", img: "https://images.unsplash.com/photo-1574348996587-27da2f36ec46?w=400", options: ["painting pictures", "making puppets", "making boats", "painting masks"], answer: "making puppets", exp: "Nh√¨n h√¨nh: Hai b·∫°n ƒëang l√†m con r·ªëi.", hint: "Puppets nghƒ©a l√† nh·ªØng con r·ªëi." },
        { id: 21, type: QuestionType.MULTIPLE_CHOICE, text: "Are the books on the table? ‚Äì Yes, they ... .", options: ["am", "is", "are", "to"], answer: "are", exp: "They are l√† c√¢u tr·∫£ l·ªùi cho Are they...?", hint: "Ch·ªß ng·ªØ 'they' lu√¥n ƒëi v·ªõi 'are'." },
        { id: 22, type: QuestionType.MULTIPLE_CHOICE, text: "Let‚Äôs draw a picture of a ... .", img: "https://images.unsplash.com/photo-1719027103866-feacf3a4f679?w=400", options: ["dog", "fish", "cat", "Monkey"], answer: "Monkey", exp: "Nh√¨n h√¨nh: Ch√∫ kh·ªâ (Monkey).", hint: "Con v·∫≠t n√†y th√≠ch ƒÉn chu·ªëi." },
        { id: 23, type: QuestionType.REARRANGE, parts: ["Open", "your", "book,", "please."], answer: "Open your book, please.", exp: "C√¢u m·ªánh l·ªánh: H√£y m·ªü s√°ch ra.", hint: "B·∫Øt ƒë·∫ßu b·∫±ng ƒë·ªông t·ª´ 'Open'." },
        { id: 24, type: QuestionType.FILL_IN_BLANK, text: "Her father raises cows, sheep and _ _ _ _ _ on his farm.", audio: "https://res.ioe.vn/edu/EOlympic/ExamData/ImageExam/2016/12/1/636161990907660300_Audio.mp3", answer: "goats", exp: "Goats: con d√™.", hint: "Nh·ªØng con v·∫≠t c√≥ s·ª´ng, b·∫Øt ƒë·∫ßu b·∫±ng 'g', 5 ch·ªØ c√°i." },
        { id: 25, type: QuestionType.FILL_IN_BLANK, text: "Is he strong or _ _ _ _ ?", answer: "weak", exp: "Tr√°i nghƒ©a v·ªõi strong (m·∫°nh) l√† weak (y·∫øu).", hint: "T·ª´ tr√°i nghƒ©a v·ªõi 'strong', c√≥ 4 ch·ªØ c√°i." },
        { id: 26, type: QuestionType.MULTIPLE_CHOICE, text: "Ch·ªçn t·ª´ kh√°c lo·∫°i:", options: ["chair", "monkey", "rabbit", "fish"], answer: "chair", exp: "Chair l√† ƒë·ªì v·∫≠t, c√≤n l·∫°i l√† ƒë·ªông v·∫≠t.", hint: "T√¨m t·ª´ kh√¥ng ph·∫£i l√† con v·∫≠t." },
        { id: 27, type: QuestionType.FILL_IN_BLANK, text: "Everyday, I ____ up early to do morning exercises.", answer: "get", exp: "Get up: th·ª©c d·∫≠y.", hint: "ƒê·ªông t·ª´ ƒëi c√πng v·ªõi 'up' ƒë·ªÉ ch·ªâ vi·ªác th·ª©c d·∫≠y." },
        { id: 28, type: QuestionType.FILL_IN_BLANK, text: "____ are you? - I‚Äôm fine, thanks.", answer: "How", exp: "How are you? l√† c√¢u h·ªèi s·ª©c kh·ªèe.", hint: "T·ª´ ƒë·ªÉ h·ªèi v·ªÅ t√¨nh h√¨nh s·ª©c kh·ªèe." },
        { id: 29, type: QuestionType.FILL_IN_BLANK, text: "I wa_ born in October.", answer: "s", exp: "I was born: t√¥i sinh ra v√†o.", hint: "Ch·ªØ c√°i c√≤n thi·∫øu c·ªßa 'was'." },
        { id: 30, type: QuestionType.REARRANGE, parts: ["I like", "playing", "football", "in", "the rain."], answer: "I like playing football in the rain.", exp: "S·ªü th√≠ch ch∆°i b√≥ng ƒë√° d∆∞·ªõi m∆∞a.", hint: "B·∫Øt ƒë·∫ßu b·∫±ng 'I like'." },
        { id: 31, type: QuestionType.MULTIPLE_CHOICE, text: "What _______ does Anh have? ‚Äì She has three yo-yos.", options: ["books", "pens", "pets", "toys"], answer: "toys", exp: "Yo-yo l√† ƒë·ªì ch∆°i (toys).", hint: "Yo-yo thu·ªôc nh√≥m ƒë·ªì v·∫≠t n√†o?" },
        { id: 32, type: QuestionType.MULTIPLE_CHOICE, text: "Where is Mary from?", options: ["She‚Äôs from England.", "She from England.", "She does England.", "England from"], answer: "She‚Äôs from England.", exp: "C√¢u tr·∫£ l·ªùi ƒë√∫ng c·∫•u tr√∫c: She's from + Country.", hint: "C·∫ßn c√≥ ƒë·ªông t·ª´ To Be 'is' (vi·∫øt t·∫Øt l√† 's)." },
        { id: 33, type: QuestionType.REARRANGE, parts: ["My dad", "is", "short", "but", "handsome."], answer: "My dad is short but handsome.", exp: "B·ªë t·ªõ th·∫•p nh∆∞ng ƒë·∫πp trai.", hint: "B·∫Øt ƒë·∫ßu v·ªõi 'My dad'." },
        { id: 34, type: QuestionType.REARRANGE, parts: ["I have", "Maths", "every day", "of", "the week."], answer: "I have Maths every day of the week.", exp: "T·ªõ h·ªçc to√°n m·ªói ng√†y trong tu·∫ßn.", hint: "B·∫Øt ƒë·∫ßu v·ªõi 'I have'." },
        { id: 35, type: QuestionType.FILL_IN_BLANK, text: "Their town is ____ .", audio: "https://res.ioe.vn/edu/EOlympic/ExamData/ImageExam/2016/12/1/636162028476800629_Audio.mp3", answer: "small", exp: "Nghe t·ª´: small (nh·ªè b√©).", hint: "T·ª´ c√≥ 5 ch·ªØ c√°i, nghƒ©a l√† nh·ªè." },
        { id: 36, type: QuestionType.MULTIPLE_CHOICE, text: "Ch·ªçn t·ª´ c√≥ ph·∫ßn g·∫°ch ch√¢n ph√°t √¢m kh√°c:", options: ["Zoo", "School", "Book", "Food"], answer: "Book", exp: "Book ph√°t √¢m / ä/, c√°c t·ª´ c√≤n l·∫°i ph√°t √¢m /uÀê/.", hint: "ƒê·ªÉ √Ω √¢m 'oo' ng·∫Øn hay d√†i." },
        { id: 37, type: QuestionType.REARRANGE, parts: ["Mary", "is", "a student", "at", "Oxford Primary School."], answer: "Mary is a student at Oxford Primary School.", exp: "Mary l√† h·ªçc sinh tr∆∞·ªùng Oxford.", hint: "B·∫Øt ƒë·∫ßu b·∫±ng t√™n ri√™ng 'Mary'." },
        { id: 38, type: QuestionType.FILL_IN_BLANK, text: "Thank you very m_ _ h.", answer: "much", exp: "Thank you very much: c·∫£m ∆°n nhi·ªÅu.", hint: "T·ª´ c√≥ 4 ch·ªØ c√°i, mang nghƒ©a 'r·∫•t nhi·ªÅu'." },
        { id: 39, type: QuestionType.FILL_IN_BLANK, text: "Her _________ food is ice-cream.", audio: "https://res.ioe.vn/edu/EOlympic/ExamData/ImageExam/2016/12/1/636161990316877921_Audio.mp3", answer: "favourite", exp: "Favourite: y√™u th√≠ch nh·∫•t.", hint: "T·ª´ ch·ªâ s·ª± y√™u th√≠ch nh·∫•t, c√≥ 9 ch·ªØ c√°i." },
        { id: 40, type: QuestionType.FILL_IN_BLANK, text: "Write the sent_ _ ces.", answer: "en", exp: "Sentences: nh·ªØng c√¢u vƒÉn.", hint: "H·∫≠u t·ªë ƒë·ªÉ t·∫°o th√†nh s·ªë nhi·ªÅu c·ªßa 'sentence'." }
      ];

      const FINAL_DATA = RAW_QUESTIONS;

      const shuffle = (array) => {
        const arr = [...array];
        for (let i = arr.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
      };

      // --- COMPONENTS ---
      const Button = ({ children, variant = 'primary', className = '', ...props }) => {
        const variants = {
          primary: "bg-indigo-600 text-white shadow-indigo-100 hover:bg-indigo-700",
          secondary: "bg-emerald-500 text-white shadow-emerald-100 hover:bg-emerald-600",
          danger: "bg-rose-500 text-white shadow-rose-100 hover:bg-rose-600",
          outline: "bg-white border-2 border-slate-200 text-slate-600 hover:border-indigo-500 hover:text-indigo-600"
        };
        return (
          <button className={`px-6 py-3 rounded-2xl font-bold transition-all btn-pop shadow-md flex items-center justify-center gap-2 disabled:opacity-50 ${variants[variant]} ${className}`} {...props}>
            {children}
          </button>
        );
      };

      const QuestionContent = ({ question, onAnswer, isAnswered, userAnswer }) => {
        const [fibInput, setFibInput] = useState('');
        const [reParts, setReParts] = useState([]);
        const [showHint, setShowHint] = useState(false);

        // Jumble rearrangement parts specifically for this question instance
        const jumbledParts = useMemo(() => {
          if (question.type === QuestionType.REARRANGE && question.parts) {
            return shuffle(question.parts);
          }
          return [];
        }, [question.id]);

        useEffect(() => {
          setFibInput('');
          setReParts([]);
          setShowHint(false);
        }, [question.id]);

        const normalize = (s) => s ? s.replace(/[.,!?;:'"]/g, '').replace(/\s+/g, ' ').trim().toLowerCase() : "";
        const isCorrect = userAnswer && normalize(userAnswer) === normalize(question.answer);

        const checkAnswer = () => {
          if (question.type === QuestionType.REARRANGE) onAnswer(reParts.join(' '));
          else onAnswer(fibInput.trim());
        };

        const handleKeyDown = (e) => {
          if (e.key === 'Enter' && !isAnswered) {
            if (question.type === QuestionType.FILL_IN_BLANK && fibInput.trim()) checkAnswer();
            if (question.type === QuestionType.REARRANGE && reParts.length > 0) checkAnswer();
          }
        };

        const toggleRePart = (p) => {
          if (isAnswered) return;
          if (reParts.includes(p)) setReParts(reParts.filter(x => x !== p));
          else setReParts([...reParts, p]);
        };

        return (
          <div className="w-full max-w-2xl mx-auto question-card-enter" onKeyDown={handleKeyDown} tabIndex="0">
            <div className="bg-white rounded-[2.5rem] shadow-2xl p-6 sm:p-10 border border-slate-100 outline-none">
              <div className="flex justify-between items-center mb-6">
                <span className="bg-slate-100 text-slate-500 px-3 py-1 rounded-lg text-[10px] font-black uppercase tracking-widest">
                  {question.type === 'MC' ? 'Tr·∫Øc nghi·ªám' : question.type === 'FIB' ? 'ƒêi·ªÅn t·ª´' : 'S·∫Øp x·∫øp'}
                </span>
                <button 
                  onClick={() => setShowHint(!showHint)} 
                  className={`text-[10px] font-bold px-3 py-1 rounded-lg border transition-all ${showHint ? 'bg-amber-500 text-white border-amber-600' : 'text-amber-600 bg-amber-50 border-amber-100'}`}
                >
                  {showHint ? '·∫®N G·ª¢I √ù' : 'G·ª¢I √ù üí°'}
                </button>
              </div>

              {question.img && <img src={question.img} className="w-full h-48 object-cover rounded-3xl mb-6 shadow-md border border-slate-100" alt="minh h·ªça" />}
              
              {question.audio && (
                <div className="mb-6 flex justify-center">
                  <button onClick={() => new Audio(question.audio).play()} className="p-4 bg-indigo-600 text-white rounded-2xl flex items-center gap-3 shadow-lg btn-pop">
                    <span className="text-2xl">üîä</span> <span className="font-bold">B·∫•m ƒë·ªÉ nghe</span>
                  </button>
                </div>
              )}

              {showHint && !isAnswered && (
                <div className="mb-6 p-5 bg-amber-50 border-l-8 border-amber-400 rounded-2xl text-amber-900 font-bold text-base shadow-sm animate-slide-up">
                  <div className="flex items-center gap-2 mb-1">
                    <span className="text-xl">üí°</span> <span className="text-xs uppercase font-black opacity-60">G·ª£i √Ω chi ti·∫øt:</span>
                  </div>
                  {question.hint || `ƒê√°p √°n c√≥ ${question.answer.length} k√Ω t·ª±.`}
                </div>
              )}

              <h2 className="text-3xl font-nunito font-black text-slate-800 mb-8 leading-tight text-center">
                {question.text || 'S·∫Øp x·∫øp c√°c t·ª´ sau th√†nh c√¢u ƒë√∫ng:'}
              </h2>

              {question.type === QuestionType.MULTIPLE_CHOICE && (
                <div className="grid grid-cols-1 gap-3">
                  {question.options.map((opt, i) => {
                    const isSelected = userAnswer === opt;
                    const isCorr = normalize(opt) === normalize(question.answer);
                    let cls = "bg-slate-50 border-slate-100 hover:border-indigo-300";
                    if (isAnswered) {
                        if (isCorr) cls = "bg-emerald-50 border-emerald-500 text-emerald-900 ring-4 ring-emerald-100";
                        else if (isSelected) cls = "bg-rose-50 border-rose-500 text-rose-900 ring-4 ring-rose-100";
                        else cls = "opacity-40 border-slate-100 grayscale pointer-events-none";
                    }
                    return (
                      <button key={i} onClick={() => !isAnswered && onAnswer(opt)} disabled={isAnswered} className={`w-full p-5 rounded-2xl text-left border-2 transition-all flex items-center gap-4 ${cls}`}>
                        <span className={`w-10 h-10 shrink-0 rounded-xl flex items-center justify-center text-lg font-black ${isAnswered && isCorr ? 'bg-emerald-500 text-white' : 'bg-white text-slate-400 shadow-sm'}`}>
                          {String.fromCharCode(65+i)}
                        </span>
                        <span className="text-xl font-bold">{opt}</span>
                      </button>
                    );
                  })}
                </div>
              )}

              {question.type === QuestionType.FILL_IN_BLANK && (
                <div className="space-y-6">
                  <input 
                    type="text" 
                    placeholder="Nh·∫≠p ƒë√°p √°n..." 
                    value={isAnswered ? userAnswer : fibInput} 
                    onChange={e => setFibInput(e.target.value)} 
                    onKeyDown={handleKeyDown}
                    disabled={isAnswered} 
                    autoFocus
                    className={`w-full p-6 rounded-3xl border-4 text-3xl font-black text-center outline-none transition-all ${isAnswered ? (isCorrect ? 'border-emerald-500 bg-emerald-50 text-emerald-800' : 'border-rose-500 bg-rose-50 text-rose-800') : 'border-slate-100 bg-slate-50 focus:border-indigo-500 focus:bg-white focus:ring-8 focus:ring-indigo-100'}`} 
                  />
                  {!isAnswered && <Button onClick={checkAnswer} className="w-full !py-5 text-xl" disabled={!fibInput.trim()}>X√ÅC NH·∫¨N (ENTER)</Button>}
                </div>
              )}

              {question.type === QuestionType.REARRANGE && (
                <div className="space-y-6">
                  <div className="flex flex-wrap gap-2.5 p-5 bg-slate-50 rounded-2xl border border-slate-200 min-h-[100px] justify-center items-center shadow-inner">
                    {jumbledParts.map((p, i) => (
                      <button key={i} onClick={() => toggleRePart(p)} disabled={isAnswered || reParts.includes(p)} className={`px-5 py-3 rounded-xl bg-white border-2 border-slate-200 font-black text-lg shadow-sm transition-all active:scale-90 ${reParts.includes(p) ? 'opacity-20 scale-95' : 'hover:border-indigo-400 hover:text-indigo-600'}`}>{p}</button>
                    ))}
                  </div>
                  <div className={`min-h-[120px] p-6 rounded-[2rem] border-4 border-dashed flex flex-wrap gap-3 justify-center items-center transition-all ${isAnswered ? (isCorrect ? 'border-emerald-500 bg-emerald-50' : 'border-rose-500 bg-rose-50') : 'border-slate-200 bg-white'}`}>
                    {reParts.length === 0 && !isAnswered && <span className="text-slate-300 font-bold italic">B·∫•m ch·ªçn c√°c t·ª´ v·ª±ng ph√≠a tr√™n...</span>}
                    {reParts.map((p, i) => (
                      <button key={i} onClick={() => toggleRePart(p)} disabled={isAnswered} className="bg-indigo-600 text-white px-5 py-3 rounded-xl font-black text-lg shadow-lg animate-slide-up">{p}</button>
                    ))}
                  </div>
                  {!isAnswered && (
                    <div className="flex gap-4">
                      <Button variant="outline" onClick={() => setReParts([])} className="flex-1 !rounded-2xl">L√ÄM L·∫†I</Button>
                      <Button onClick={checkAnswer} className="flex-[2] !py-5 text-xl !rounded-2xl" disabled={reParts.length === 0}>X√ÅC NH·∫¨N (ENTER)</Button>
                    </div>
                  )}
                </div>
              )}

              {isAnswered && (
                <div className={`mt-8 p-6 rounded-3xl border-l-[12px] shadow-lg animate-slide-in ${isCorrect ? 'bg-emerald-50 border-emerald-500' : 'bg-rose-50 border-rose-500'}`}>
                  <div className="flex items-start gap-5">
                    <div className={`w-14 h-14 rounded-2xl flex items-center justify-center text-white text-3xl font-black shadow-md ${isCorrect ? 'bg-emerald-500' : 'bg-rose-500'}`}>
                      {isCorrect ? '‚úì' : '‚úï'}
                    </div>
                    <div className="flex-1">
                      <h3 className={`text-2xl font-black mb-2 ${isCorrect ? 'text-emerald-800' : 'text-rose-800'}`}>{isCorrect ? 'CH√çNH X√ÅC!' : 'SAI M·∫§T R·ªíI!'}</h3>
                      {!isCorrect && (
                        <div className="mb-3 p-3 bg-white/80 rounded-xl border border-rose-100">
                           <p className="text-[10px] font-black text-rose-400 uppercase tracking-widest mb-1">ƒê√°p √°n ƒë√∫ng l√†:</p>
                           <p className="text-xl font-black text-slate-800 leading-tight">{question.answer}</p>
                        </div>
                      )}
                      <p className="text-slate-700 font-bold leading-relaxed">
                        <span className="text-indigo-600 text-xs font-black mr-2 uppercase bg-indigo-50 px-2 py-0.5 rounded">Gi·∫£i th√≠ch:</span>
                        {question.exp}
                      </p>
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>
        );
      };

      const StartScreen = ({ onStart }) => {
        const [name, setName] = useState(localStorage.getItem('ioe_name') || '');
        return (
          <div className="min-h-screen flex items-center justify-center bg-indigo-600 p-6 relative overflow-hidden">
             <div className="absolute top-0 left-0 w-full h-full opacity-10 pointer-events-none">
                <div className="grid grid-cols-10 gap-4">
                  {Array.from({length: 100}).map((_, i) => <span key={i} className="text-white text-4xl">ABC</span>)}
                </div>
             </div>
            <div className="bg-white rounded-[3.5rem] shadow-2xl p-10 sm:p-16 max-w-xl w-full text-center relative z-10 border-8 border-white">
              <span className="text-8xl mb-8 block animate-float">üéì</span>
              <h1 className="text-5xl font-nunito font-black text-slate-800 mb-2 tracking-tighter">IOE L·ªöP 4</h1>
              <p className="text-slate-400 font-black uppercase tracking-widest text-sm mb-12">B·ªò ƒê·ªÄ √îN T·∫¨P S·ªê 09 - 200 C√ÇU</p>
              <form onSubmit={e => { e.preventDefault(); name.trim() && onStart(name); }} className="space-y-6 text-left">
                <label className="text-xs font-black text-slate-400 uppercase tracking-widest ml-4">T√™n ng∆∞·ªùi ch∆°i:</label>
                <input type="text" value={name} onChange={e => setName(e.target.value)} placeholder="NH·∫¨P T√äN C·ª¶A B·∫†N" required className="w-full px-8 py-6 rounded-3xl border-4 border-slate-100 text-2xl font-black text-center outline-none focus:border-indigo-500 transition-all uppercase shadow-inner" />
                <Button type="submit" className="w-full !py-7 text-2xl !rounded-[2rem] shadow-xl">V√ÄO THI NGAY</Button>
              </form>
            </div>
          </div>
        );
      };

      const ResultScreen = ({ userName, userAnswers, score, onRetryAll, onRetryWrong }) => {
        const [showReview, setShowReview] = useState(false);
        const correctCount = userAnswers.filter(a => a.isCorr).length;
        const total = userAnswers.length;
        const percent = total > 0 ? Math.round((correctCount / total) * 100) : 0;
        const wrongOnes = userAnswers.filter(a => !a.isCorr);

        useEffect(() => {
          if (percent > 70) confetti({ particleCount: 200, spread: 90, origin: { y: 0.6 } });
        }, []);

        return (
          <div className="min-h-screen bg-slate-50 flex flex-col items-center justify-center p-6 py-12">
            <div className="bg-white rounded-[4rem] p-10 sm:p-16 shadow-2xl text-center max-w-3xl w-full border-4 border-white animate-slide-in">
              <span className="text-8xl mb-8 block"> {percent > 85 ? 'üåü' : percent > 50 ? 'üçÄ' : 'üí™'} </span>
              <h2 className="text-5xl font-nunito font-black text-slate-800 mb-2 uppercase">K·∫æT QU·∫¢</h2>
              <p className="text-slate-400 font-bold uppercase tracking-widest text-sm mb-10">Ng∆∞·ªùi ch∆°i: <span className="text-indigo-600">{userName}</span></p>
              
              <div className="grid grid-cols-2 gap-6 mb-12">
                <div className="bg-indigo-50 p-10 rounded-[3rem] border border-indigo-100 flex flex-col items-center shadow-sm">
                    <p className="text-5xl font-black text-indigo-600">{score}</p>
                    <p className="text-[11px] font-black text-indigo-400 uppercase tracking-widest mt-2">T·ªïng ƒêi·ªÉm</p>
                </div>
                <div className="bg-emerald-50 p-10 rounded-[3rem] border border-emerald-100 flex flex-col items-center shadow-sm">
                    <p className="text-5xl font-black text-emerald-600">{percent}%</p>
                    <p className="text-[11px] font-black text-emerald-400 uppercase tracking-widest mt-2">ƒê·ªô ch√≠nh x√°c</p>
                </div>
              </div>

              <div className="flex flex-col sm:flex-row gap-4 mb-10">
                <Button onClick={onRetryAll} className="flex-1 !py-6 text-xl !rounded-[2rem]">CH∆†I L·∫†I T·ª™ ƒê·∫¶U</Button>
                {wrongOnes.length > 0 && (
                  <Button onClick={onRetryWrong} variant="danger" className="flex-1 !py-6 text-xl !rounded-[2rem]">L√ÄM L·∫†I C√ÇU SAI</Button>
                )}
                <Button onClick={() => setShowReview(!showReview)} variant="outline" className="flex-1 !py-6 text-xl !rounded-[2rem]">
                  {showReview ? 'ƒê√ìNG XEM L·∫†I' : '√îN T·∫¨P C√ÇU SAI'}
                </Button>
              </div>

              {showReview && (
                <div className="text-left space-y-5 max-h-[500px] overflow-y-auto pr-3 custom-scrollbar border-t-2 pt-8">
                  <h3 className="text-2xl font-black text-slate-800 uppercase mb-6 flex items-center gap-3">
                    <span className="w-10 h-10 bg-rose-500 text-white rounded-xl flex items-center justify-center text-sm">!</span> 
                    Danh s√°ch c√¢u sai:
                  </h3>
                  {wrongOnes.map((ans, idx) => {
                    const q = FINAL_DATA.find(x => x.id === ans.qId);
                    return q ? (
                      <div key={idx} className="bg-white p-6 rounded-3xl border-2 border-slate-100 hover:border-indigo-200 transition-all shadow-sm">
                        <div className="flex justify-between items-start mb-3">
                           <span className="text-[10px] font-black px-3 py-1 bg-slate-100 text-slate-500 rounded-lg uppercase">C√¢u h·ªèi {q.id}</span>
                        </div>
                        <p className="font-black text-slate-800 mb-4 text-xl leading-snug">{q.text || 'S·∫Øp x·∫øp c√¢u:'} {q.type === QuestionType.REARRANGE && <span className="text-slate-400 font-medium italic text-sm">({q.answer})</span>}</p>
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm mb-4">
                          <div className="p-4 bg-rose-50 rounded-2xl border border-rose-100">
                            <p className="text-[10px] font-bold text-rose-400 uppercase tracking-wider mb-1">C√¢u tr·∫£ l·ªùi c·ªßa b·∫°n:</p>
                            <p className="font-black text-rose-900 text-lg">{ans.resp || "(B·ªè tr·ªëng)"}</p>
                          </div>
                          <div className="p-4 bg-emerald-50 rounded-2xl border border-emerald-100">
                            <p className="text-[10px] font-bold text-emerald-400 uppercase tracking-wider mb-1">ƒê√°p √°n ch√≠nh x√°c:</p>
                            <p className="font-black text-emerald-900 text-lg">{q.answer}</p>
                          </div>
                        </div>
                        <div className="p-4 bg-indigo-50/50 rounded-2xl">
                           <p className="text-sm text-slate-600 font-bold leading-relaxed">
                            <span className="font-black text-indigo-600 text-[10px] uppercase mr-2 bg-indigo-100 px-2 py-0.5 rounded">Gi·∫£i th√≠ch:</span> 
                            {q.exp}
                           </p>
                        </div>
                      </div>
                    ) : null;
                  })}
                </div>
              )}
            </div>
          </div>
        );
      };

      const App = () => {
        const [gameState, setGameState] = useState(GameState.START);
        const [userName, setUserName] = useState('');
        const [activeQuestions, setActiveQuestions] = useState(FINAL_DATA);
        const [currentIndex, setCurrentIndex] = useState(0);
        const [userAnswers, setUserAnswers] = useState([]);
        const [score, setScore] = useState(0);
        const [timeLeft, setTimeLeft] = useState(TOTAL_TIME);
        const [showList, setShowList] = useState(false);

        useEffect(() => {
          let timer;
          if (gameState === GameState.PLAYING && timeLeft > 0) {
            timer = setInterval(() => setTimeLeft(p => p - 1), 1000);
          } else if (timeLeft === 0 && gameState === GameState.PLAYING) setGameState(GameState.FINISHED);
          return () => clearInterval(timer);
        }, [gameState, timeLeft]);

        const handleAnswer = (resp) => {
          const q = activeQuestions[currentIndex];
          const isCorr = resp.replace(/[.,!?;:'"]/g, '').replace(/\s+/g, ' ').trim().toLowerCase() === q.answer.toLowerCase();
          
          if (isCorr) setScore(s => s + POINTS_PER_CORRECT);
          setUserAnswers(prev => [...prev.filter(a => a.qId !== q.id), { qId: q.id, resp, isCorr }]);
        };

        const handleRetryWrong = () => {
          const wrongIds = userAnswers.filter(a => !a.isCorr).map(a => a.qId);
          const wrongQuests = FINAL_DATA.filter(q => wrongIds.includes(q.id));
          setActiveQuestions(wrongQuests);
          setCurrentIndex(0);
          setUserAnswers([]);
          setScore(0);
          setTimeLeft(TOTAL_TIME);
          setGameState(GameState.PLAYING);
        };

        const handleRetryAll = () => {
          setActiveQuestions(FINAL_DATA);
          setCurrentIndex(0);
          setUserAnswers([]);
          setScore(0);
          setTimeLeft(TOTAL_TIME);
          setGameState(GameState.PLAYING);
        };

        const onJump = (idx) => { setCurrentIndex(idx); setShowList(false); };

        if (gameState === GameState.START) return <StartScreen onStart={n => { setUserName(n); setGameState(GameState.PLAYING); localStorage.setItem('ioe_name', n); }} />;

        if (gameState === GameState.FINISHED) {
            return <ResultScreen 
              userName={userName} 
              userAnswers={userAnswers} 
              score={score}
              onRetryAll={handleRetryAll}
              onRetryWrong={handleRetryWrong}
            />;
        }

        const currentQ = activeQuestions[currentIndex];
        const answer = userAnswers.find(a => a.qId === currentQ.id);
        const progress = ((currentIndex + 1) / activeQuestions.length) * 100;

        return (
          <div className="min-h-screen bg-slate-50 flex flex-col p-4 pb-32">
            <div className="w-full max-w-4xl mx-auto mb-6">
              <div className="glass rounded-[2rem] p-4 flex flex-wrap items-center justify-between gap-4 shadow-xl border-4 border-white">
                <div className="flex items-center gap-3">
                  <div className="w-12 h-12 rounded-2xl bg-indigo-600 flex items-center justify-center text-white font-black text-xl shadow-lg">
                    {userName[0]?.toUpperCase() || 'U'}
                  </div>
                  <div className="hidden sm:block">
                    <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest leading-none">Ng∆∞·ªùi ch∆°i</p>
                    <p className="text-lg font-black text-slate-800 truncate max-w-[120px]">{userName}</p>
                  </div>
                </div>
                <div className="flex items-center gap-8">
                  <div className="text-center">
                    <p className="text-[10px] font-black text-slate-400 uppercase leading-none">Th·ªùi gian</p>
                    <p className={`text-2xl font-black ${timeLeft < 60 ? 'text-rose-500 animate-pulse' : 'text-slate-800'}`}>
                      {Math.floor(timeLeft / 60)}:{(timeLeft % 60).toString().padStart(2, '0')}
                    </p>
                  </div>
                  <div className="text-center">
                    <p className="text-[10px] font-black text-slate-400 uppercase leading-none">ƒêi·ªÉm</p>
                    <p className="text-2xl font-black text-indigo-600">{score}</p>
                  </div>
                </div>
                <Button variant="outline" className="!px-5 !py-3 !rounded-2xl text-xs !border-slate-100 shadow-sm" onClick={() => setShowList(true)}>üìã DANH S√ÅCH</Button>
              </div>
              <div className="mt-5 px-3">
                <div className="w-full h-3 bg-slate-200 rounded-full overflow-hidden shadow-inner">
                  <div className="h-full bg-gradient-to-r from-indigo-500 to-indigo-700 transition-all duration-700 ease-out" style={{ width: `${progress}%` }}></div>
                </div>
              </div>
            </div>

            <QuestionContent question={currentQ} onAnswer={handleAnswer} isAnswered={!!answer} userAnswer={answer?.resp} />
            
            <div className="fixed bottom-0 left-0 right-0 p-8 bg-white/80 backdrop-blur-xl border-t border-slate-200 z-50 flex justify-center shadow-2xl">
              <div className="w-full max-w-2xl flex gap-4 items-center">
                <Button variant="outline" onClick={() => setCurrentIndex(Math.max(0, currentIndex - 1))} disabled={currentIndex === 0} className="!p-5 !rounded-2xl shrink-0 border-2">‚Üê</Button>
                <div className="flex-1">
                  {answer ? (
                    <Button onClick={() => currentIndex === activeQuestions.length - 1 ? setGameState(GameState.FINISHED) : setCurrentIndex(currentIndex + 1)} className="w-full !py-5 text-2xl !rounded-2xl shadow-indigo-200" variant="secondary">
                        {currentIndex === activeQuestions.length - 1 ? 'XEM K·∫æT QU·∫¢ üèÅ' : 'C√ÇU TI·∫æP THEO ‚Üí'}
                    </Button>
                  ) : (
                    <Button onClick={() => setCurrentIndex(Math.min(activeQuestions.length - 1, currentIndex + 1))} variant="outline" className="w-full !py-5 !rounded-2xl font-black text-slate-300 border-dashed hover:border-indigo-400 hover:text-indigo-400">B·ªé QUA C√ÇU N√ÄY</Button>
                  )}
                </div>
                <Button variant="outline" onClick={() => setCurrentIndex(Math.min(activeQuestions.length - 1, currentIndex + 1))} disabled={currentIndex === activeQuestions.length - 1 || !answer} className="!p-5 !rounded-2xl shrink-0 border-2">‚Üí</Button>
              </div>
            </div>

            {showList && (
              <div className="fixed inset-0 z-[100] bg-slate-900/70 backdrop-blur-md flex items-center justify-center p-4">
                <div className="bg-white rounded-[3rem] shadow-2xl w-full max-w-3xl max-h-[85vh] flex flex-col overflow-hidden animate-slide-up border-8 border-white">
                    <div className="p-8 border-b flex justify-between items-center bg-slate-50">
                        <div>
                           <h2 className="text-3xl font-black text-slate-800 uppercase tracking-tighter">DANH S√ÅCH C√ÇU H·ªéI</h2>
                           <p className="text-xs font-bold text-slate-400 uppercase tracking-widest">{activeQuestions.length} C√ÇU TRONG L∆Ø·ª¢T THI N√ÄY</p>
                        </div>
                        <button onClick={() => setShowList(false)} className="w-12 h-12 flex items-center justify-center text-3xl font-black text-slate-400 hover:text-rose-500 hover:bg-rose-50 rounded-2xl transition-all">‚úï</button>
                    </div>
                    <div className="flex-1 overflow-y-auto p-8 grid grid-cols-5 sm:grid-cols-10 gap-3 custom-scrollbar bg-white shadow-inner">
                        {activeQuestions.map((q, i) => {
                            const ans = userAnswers.find(a => a.qId === q.id);
                            let cls = "bg-slate-50 text-slate-300 border-slate-100 hover:border-indigo-200";
                            if (i === currentIndex) cls = "ring-4 ring-indigo-500 bg-white text-indigo-600 border-indigo-500 scale-110 z-10";
                            else if (ans) cls = ans.isCorr ? "bg-emerald-500 text-white border-emerald-600" : "bg-rose-500 text-white border-rose-600";
                            return <button key={i} onClick={() => onJump(i)} className={`h-14 rounded-2xl font-black text-lg border-2 transition-all transform active:scale-95 ${cls}`}>{q.id}</button>
                        })}
                    </div>
                    <div className="p-4 bg-slate-50 border-t text-[10px] font-black text-slate-400 flex gap-8 justify-center uppercase tracking-widest">
                       <div className="flex items-center gap-2"><span className="w-4 h-4 bg-emerald-500 rounded-lg"></span> ƒê√∫ng</div>
                       <div className="flex items-center gap-2"><span className="w-4 h-4 bg-rose-500 rounded-lg"></span> Sai</div>
                       <div className="flex items-center gap-2"><span className="w-4 h-4 bg-slate-200 rounded-lg"></span> Ch∆∞a l√†m</div>
                    </div>
                </div>
              </div>
            )}
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
</body>
</html>
